<html>
  <head>
    <title>piano 3</title>
	<meta charset='utf-8' />
	<script type="text/javascript" language="javascript">

		var context = new AudioContext();
		var can, can2, c, c2;		
		var formSignalSet = null;
		var sp = context.createScriptProcessor(1024, 1, 1);
		var an = context.createAnalyser();
		var ks; //for notes dispay
		
		var audioLybrary = new Object();
		audioLybrary.getFrequency = function(key, octave) {
			return 27.5 * Math.pow(2, (key + octave *12.0) / 12.0);
		}
		audioLybrary.FORM_SIGNAL = 'sine';
		audioLybrary.createChainOfNodes = function() {
		}
		sp.onaudioprocess = function() {
			var fFrequencyData = new Float32Array(an.frequencyBinCount);
			var bFrequencyData = new Uint8Array(an.frequencyBinCount); 
			var bTimeData = new Uint8Array(an.frequencyBinCount);
			an.getFloatFrequencyData(fFrequencyData); 
			an.getByteFrequencyData(bFrequencyData); 
			an.getByteTimeDomainData(bTimeData);
			c.clearRect(0, 0, width, height);				
			c.strokeStyle = 'white';
			c.fillStyle = 'black';
			c.fillRect(0, 0, width2, height2);
			c.beginPath();		
			c.moveTo(0,height/2);
			c.lineWidth = 1;
			for (var i = 0; i < bTimeData.length; i = i + 1) {
				var t = bTimeData[i];
				var a = bFrequencyData[i];
				var ba = bFrequencyData[i];
				var scaleX = width / bTimeData.length;
				var scaleY = (height/2 - t);				
				c.lineTo(scaleX * i, t + 25);
			}
			c.stroke();
			//*************
			c2.clearRect(0, 0, width2, height2);
			c2.strokeStyle = 'white';
			c2.fillStyle = 'black';
			c2.fillRect(0, 0, width2, height2);
			c2.fillStyle = 'white';
			c2.beginPath();		
			c2.moveTo(0,height2/2);
			c2.lineWidth = 1;
			for (var i = 0; i < bTimeData.length; i = i + 1) {
				var scaleX = width / bTimeData.length;
				var scaleY = height / height;
				var t = bTimeData[i];
				var a = bFrequencyData[i];
				var ba = bFrequencyData[i];
				c2.fillRect(i, height-a, i, height);
			}
			c2.stroke();
		};			
		
		audioLybrary.play = function(e) {
			var attack = 10;
			var decey = 490;
			//audioLybrary.createChainOfNodes();
			var key = (e.target.id[2] == '#') ? piano.NOTES.indexOf(e.target.id[0] + e.target.id[2]) : piano.NOTES.indexOf(e.target.id[0]);
			var octave = e.target.id[1];		
			var note = document.getElementById("note");
			note.innerHTML = e.target.id;
			this.osc = context.createOscillator();		
			this.gain = context.createGain();
			sp.connect(context.destination);
			an.connect(sp);
			this.osc.connect(this.gain);
			this.gain.connect(an);
			this.gain.connect(context.destination);						
			an.fftSize = 1024;
			an.smoothingTimeConstant = 0.0;
			this.osc.frequency.value = audioLybrary.getFrequency(key, octave);
			this.osc.type = (formSignalSet != null) ? formSignalSet : audioLybrary.FORM_SIGNAL;			
			this.gain.gain.setValueAtTime(0, context.currentTime);
			this.gain.gain.linearRampToValueAtTime(1, context.currentTime + attack / 1000);
			this.gain.gain.linearRampToValueAtTime(0, context.currentTime + decey / 1000);
			this.osc.start(0);
			setTimeout(
				function(e) {
					this.osc.stop(0);
					this.osc.disconnect(this.gain);
					this.gain.disconnect(context.destination);
				}, decey
			);		
		}
/*
		var i = 0;		
		var melody = ['E4', 'D4#','E4', 'D4#','E4', 'D4#','E4', 'B4', 'D4', 'C4', 'A4','-', 'C3', 'E3', 'A4', 'B4', '-', 'E3','G3#','B4','C4','-'];
		setInterval(
			function() {
				if (melody[i] != '-') document.getElementById(melody[i]).click();				
				i++;
				if (i >= melody.length) i = 0;
			}, 250
		);
*/
		
		var intId;
		function startSequence() {
			var seq = document.getElementById('notes_sequence').value;
			var i = 0;				
			if (seq.length != 0) {
				var arrForPlay = seq.split(',');			
				intId = setInterval(
					function() {
						if (arrForPlay[i] != '-') document.getElementById(arrForPlay[i]).click();				
						i++;
						if (i >= arrForPlay.length) i = 0;
					}, 350
				);
			} else alert('сотворите мелодию или скопируйте ниже сотверенные');
		}
		
		function stopSequence() {
			clearInterval(intId);
		}
		
		function addCurrentNote() {
			var note = document.getElementById('note').textContent;
			var seq = document.getElementById('notes_sequence').value;
			if (note != "") {
				if (seq == "") {
					document.getElementById('notes_sequence').value =
					document.getElementById('notes_sequence').value + 
					note;
				} else {
					document.getElementById('notes_sequence').value =
					document.getElementById('notes_sequence').value + 
					"," + note;
				}
			}
		}

		function addPause() {
			var seq = document.getElementById('notes_sequence').value;
			if (seq == "") {
				document.getElementById('notes_sequence').value =
				document.getElementById('notes_sequence').value + 
				"-";
			} else {
				document.getElementById('notes_sequence').value =
				document.getElementById('notes_sequence').value + 
				",-" ;
			}
		}

		function clr() {
			document.getElementById('notes_sequence').value = "";
		}

		var piano = new Object();
		piano.NOTES = ['A', 'A#', 'B', 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#'];
		piano.KEYS_TYPE = ['white','black'];
		piano.createKeyboard = function() {
			/*
				'keysType' must contains only values of piano.KEYS_TYPE
			*/
			function makeKey(octaveCnt, noteCnt, keysType) {
				var key = document.createElement('div');
				key.setAttribute('class', keysType);
				key.id = piano.NOTES[noteCnt][0] + octaveCnt;
				if(keysType == piano.KEYS_TYPE[1]) key.id += '#';
				//key.innerHTML = key.id;
				return key;
			}
			function makeKeyboard() {
				var keyboard = document.createElement('div');
				var offset = 50;
				keyboard.setAttribute('id', 'keys');
				var keyNumber = 0;
				var key;
				var whiteKeyCnt = 0;
				for(var octaveCnt = 0; octaveCnt < 8; octaveCnt++) {
					for (var noteCnt = 0; noteCnt < 12; noteCnt++) {
						keyNumber = (octaveCnt * 12) + noteCnt;
						if (keyNumber > 87) break;
						switch (noteCnt % 12) {
							//  ['A', 'A#', 'B', 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#'];					
							case 1: case 4: case 6: case 9: case 11:
								key = makeKey(octaveCnt, noteCnt, piano.KEYS_TYPE[1]);
								key.style.left = whiteKeyCnt * 21 - 8 + offset; // width of white key minus half of black key 
							break;
							default:
								key = makeKey(octaveCnt, noteCnt, piano.KEYS_TYPE[0]);	
								key.style.left = whiteKeyCnt * 21 + offset;
								whiteKeyCnt++;
						}
						keyboard.appendChild(key);
					}
				}
				return keyboard;
			}
			return makeKeyboard();
		}	

		window.onload = function() {
			document.body.addEventListener('click', audioLybrary.play);
//			document.body.addEventListener('click', getNote);
			document.body.appendChild(piano.createKeyboard());			
			can = document.getElementById('area');
			width = can.width;
			height = can.height;
			c = can.getContext('2d');
			c.clearRect(0, 0, width, height);
			can2 = document.getElementById('area2');			
			width2 = can2.width;
			height2 = can2.height;
			c2 = can2.getContext('2d');
			c2.clearRect(0, 0, width2, height2);
		}

	</script>
	<style>
		* {
			color: white;
			background-color: black;
		}
		ul.melodies  {
			position: absolute;
			top: 650px;
		}
		li.garbage {
			list-style-type: none;
		}
		ul.garbage {
			position: absolute;
			top: 210px;
			list-style-type: none;
		}
		div:active {
			background: orange;
		}
		.black {
			background-color: black;
			border: 1px solid black;		
			height: 120px;
			width: 15px;
			position: absolute;
			top: 0;
			z-Index: 10;
			color: white;
		}
		.white {
			background-color: white;
			border: 1px solid black;		
			height: 200px;
			width: 21px;
			position: absolute;
			top: 0;
			color: black;
			vertical-align:bottom;
		}
		#note {
			height: 200px;
			width: 350px;
			position: absolute;
			top: 0;
			right: 0;
			background-color: black;
			color: white;
			font-size: 120pt;
		}
</style>
  </head>
  <body>
		<span id="note" ></span>
	<ul class="garbage">
		<li>
			<canvas height='300' width='600' id='area'>press f5</canvas>
			<canvas height='300' width='600' id='area2'>press f5</canvas>
		</li>
		<li>
			<span>Type of wave:</span>
			<input type="radio"  name="forme" value="sine" checked onchange="formSignalSet = 'sine'">sine</input>
			<input type="radio" name="forme" value="square" onchange="formSignalSet = 'square'">square</input>
			<input type="radio" name="forme" value="sawtooth" onchange="formSignalSet = 'sawtooth'">sawtooth</input>
			<input type="radio" name="forme" value="triangle" onchange="formSignalSet = 'triangle'">triangle</input>
		</li>
		<hr />
		<li>
			<textarea id="notes_sequence" name="name" cols="100" rows="3"></textarea>
			<button onclick="startSequence()" >start</button>
			<button onclick="stopSequence()">stop</button>
			<button onclick="clr()">clear</button>
			<button onclick="addCurrentNote()">add current note</button>
			<button onclick="addPause()">add pause</button>
		</li>
	</ul>
	<ul class="melodies">
		<p>
			ниже сотворенные мелодии!
		</p>
		<li>
		G2#,C3#,E3,G2#,C3#,E3,G2#,C3#,E3,G2#,C3#,E3,A3,C3#,E3,A3,C3#,E3,A3,D3,G3,A3,D3,G3,G2#,C3,F3#,G2#,C3#,E3,G2#,C3#,D3#,F2#,C3,E3,E2,G2#,C3#,G2#,C3#,E3,G2#,C3#,E3,G3#,-,G3#,G3#,G2#,D3#,F3#,G2#,D3#,F3#,G2#,D3#,F3#,G2#,D3#,F3#,G3#,-,G3#,G3#,G2#,C3#,E3,G2#,C3#,E3,A4,C3#,F3#,A3,C3#,F3#,G3#,B3,E3,G2#,B3,E3,F3#,A3,B3,E3,B4,B3,D3#,E3,B3,E3,G2#,B3,E3,G2#,B3,E3,G2#,B3,E3,G2,B3,E3,G2,B3,E3,G2,B3,E3,G3,G2,B3,E3,G3,G3,B3,F3,G2,B3,F3,G2,B3,F3,G3,B3,G3,G3,C3,G2,B3,E3,G2,,C3#,E3,F3#,C3#,E3,F2#,A2#,A1#,C0#,-,C0#,-,C0#,-,C0#,-,C0#,-,-,-,-,-		
		</li>
		<li>
		E4,D4#,E4,D4#,E4,D4#,E4,B4,D4,C4,A4,-,C3,E3,A4,B4,-,E3,G3#,B4,C4,-
		</li>
	<ul>
  </body>
</html>
